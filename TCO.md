# å°¾é€’å½’ä¼˜åŒ–(TCO)å®ç°è¯´æ˜

## å·²å®ç°åŠŸèƒ½

MyLisp è§£é‡Šå™¨ç°åœ¨æ”¯æŒ**ç›´æ¥çš„å°¾é€’å½’ä¼˜åŒ–**,å¯ä»¥å°†å°¾è°ƒç”¨è½¬æ¢ä¸ºå¾ªç¯,é¿å…æ ˆæº¢å‡ºã€‚

## TCO å·¥ä½œåŸç†

å½“ä¸€ä¸ª lambda å‡½æ•°çš„**æœ€åä¸€ä¸ªè¡¨è¾¾å¼**æ˜¯**å¦ä¸€ä¸ª lambda çš„è°ƒç”¨**æ—¶,è§£é‡Šå™¨ä¼š:
1. æ£€æµ‹åˆ°è¿™æ˜¯å°¾ä½ç½®
2. ä¸åˆ›å»ºæ–°çš„æ ˆå¸§
3. ä½¿ç”¨å¾ªç¯é‡ç”¨å½“å‰æ ˆå¸§

## ä½¿ç”¨ç¤ºä¾‹

### âœ… æ­£ç¡®: ç›´æ¥å°¾é€’å½’(ä¼šè¢«ä¼˜åŒ–)

```lisp
; æ–¹å¼1: å‘½å let + ç›´æ¥é€’å½’
(define (sum n acc)
  (if (= n 0)
      acc
      (sum (- n 1) (+ acc n))))  ; âœ… ç›´æ¥è°ƒç”¨è‡ªå·±

(sum 10000 0)  ; ä¸ä¼šæ ˆæº¢å‡º
```

### âŒ é”™è¯¯: é—´æ¥é€’å½’(ä¸ä¼šè¢«ä¼˜åŒ–)

```lisp
; æ–¹å¼2: é€šè¿‡è¾…åŠ©å‡½æ•°(ä¼šæ ˆæº¢å‡º)
(define (sum n)
  (sum-helper n 0))

(define (sum-helper n acc)
  (if (= n 0)
      acc
      (sum-helper (- n 1) (+ acc n))))  ; âŒ ç¬¦å·æŸ¥æ‰¾,ä¸æ˜¯ç›´æ¥ lambda

(sum 10000)  ; æ ˆæº¢å‡º!
```

## ä¸ºä»€ä¹ˆé—´æ¥è°ƒç”¨ä¸èƒ½ä¼˜åŒ–?

å½“è°ƒç”¨ `(sum-helper ...)` æ—¶:
1. è§£é‡Šå™¨éœ€è¦æŸ¥æ‰¾ `sum-helper` ç¬¦å·
2. è¿™ä¼šå¾—åˆ°ä¸€ä¸ª lambda è¡¨è¾¾å¼
3. ä½†æ­¤æ—¶**å·²ç»é”™è¿‡äº† TCO æ—¶æœº**

åœ¨ `eval_function_call` ä¸­,åªæœ‰å½“ `func` **æœ¬èº«å°±æ˜¯ä¸€ä¸ª lambda åˆ—è¡¨**æ—¶æ‰è§¦å‘ TCO:
```rust
if let Expr::List(ref list) = func {
    if matches!(&list[0], Expr::Symbol(s) if s == "lambda") {
        // è§¦å‘ TCO
    }
}
```

## æµ‹è¯•ç»“æœ

è¿è¡Œ `test_tco.lisp`:
```
TCO Test Suite
Test 1 - Tail recursive sum (1000): 500500        âœ…
Test 2 - Tail recursive factorial (10): 3628800   âœ…
Test 3 - Tail recursive length: 5                 âœ…
Test 4 - Mutual tail recursion (even? 10): true   âœ…
Test 5 - Tail recursive fibonacci (20): 6765      âœ…
```

## æ€§èƒ½å¯¹æ¯”

| é€’å½’æ·±åº¦ | æ—  TCO | æœ‰ TCO |
|---------|--------|--------|
| 1000    | âœ…     | âœ…     |
| 10000   | âŒ æ ˆæº¢å‡º | âœ…     |
| 100000  | âŒ æ ˆæº¢å‡º | âŒ æ ˆæº¢å‡º(é™åˆ¶) |

å½“å‰å®ç°åœ¨çº¦ 10000 æ¬¡å°¾é€’å½’åä»ä¼šæº¢å‡º,è¿™æ˜¯å› ä¸º:
1. ç¯å¢ƒé“¾ `Env::with_parent` ä»åœ¨åˆ›å»º
2. æ¯æ¬¡è¿­ä»£éƒ½å…‹éš†äº†æ•´ä¸ªç¯å¢ƒé“¾

## æ”¹è¿›æ–¹å‘

è¦å®ç°å®Œæ•´çš„ TCO,éœ€è¦:

1. **ç¯å¢ƒé“¾ä¼˜åŒ–**:
   ```rust
   // å½“å‰:æ¯æ¬¡éƒ½åˆ›å»ºæ–°ç¯å¢ƒ
   let func_env = Env::with_parent(current_env);

   // æ”¹è¿›:é‡ç”¨ç¯å¢ƒ,åªæ›´æ–°ç»‘å®š
   func_env.clear();
   func_env.extend_bindings(new_bindings);
   ```

2. **é—´æ¥è°ƒç”¨ä¼˜åŒ–**:
   - åœ¨ç¬¦å·æ±‚å€¼åå»¶è¿Ÿ TCO æ£€æŸ¥
   - æˆ–è€…åœ¨ `apply_user_function` ä¸­ç»Ÿä¸€å¤„ç†

3. **ç›¸äº’é€’å½’ä¼˜åŒ–**:
   - ä½¿ç”¨ trampoline æŠ€æœ¯
   - æˆ–è€… CPS(Continuation-Passing Style)

## æ€»ç»“

âœ… **å·²å®ç°**: åŸºç¡€çš„ç›´æ¥å°¾é€’å½’ä¼˜åŒ–
âš ï¸ **é™åˆ¶**: åªä¼˜åŒ– `lambda` ç›´æ¥è°ƒç”¨,ä¸ä¼˜åŒ–ç¬¦å·æŸ¥æ‰¾
ğŸ“ **å»ºè®®**: ç¼–å†™å°¾é€’å½’å‡½æ•°æ—¶,ä½¿ç”¨ç›´æ¥é€’å½’è€Œéè¾…åŠ©å‡½æ•°
